steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/spring-boot-hello:$COMMIT_SHA', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/spring-boot-hello:latest', './spring-boot-hello']

# Build the Spring Boot Worker container image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/spring-boot-worker:$COMMIT_SHA', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/spring-boot-worker:latest', './spring-boot-worker']

# Push the Hello World container image
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/spring-boot-hello:$COMMIT_SHA']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/spring-boot-hello:latest']

# Push the Worker container image
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/spring-boot-worker:$COMMIT_SHA']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/spring-boot-worker:latest']

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'gcloud'
  args: ['services', 'enable', 'run.googleapis.com', 'artifactregistry.googleapis.com', 'pubsub.googleapis.com', 'compute.googleapis.com', '--project', '$PROJECT_ID']

- id: 'tf-init'
  name: 'hashicorp/terraform:1.5.7'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      cd terraform/gcp
      terraform init

- id: 'tf-plan'
  name: 'hashicorp/terraform:1.5.7'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      cd terraform/gcp
      export TF_VAR_commit_sha=$COMMIT_SHA
      export TF_VAR_project_id=${_TF_VAR_PROJECT_ID}
      export TF_VAR_compute_service_account=${_TF_VAR_COMPUTE_SERVICE_ACCOUNT}
      export TF_VAR_region=${_TF_VAR_REGION}
      export TF_VAR_aws_access_key_id=${_TF_VAR_AWS_ACCESS_KEY_ID}
      export TF_VAR_aws_secret_access_key=${_TF_VAR_AWS_SECRET_ACCESS_KEY}
      export TF_VAR_aws_region=${_TF_VAR_AWS_REGION}
      terraform plan

- id: 'tf-apply'
  name: 'hashicorp/terraform:1.5.7'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      cd terraform/gcp
      export TF_VAR_commit_sha=$COMMIT_SHA
      export TF_VAR_project_id=${_TF_VAR_PROJECT_ID}
      export TF_VAR_compute_service_account=${_TF_VAR_COMPUTE_SERVICE_ACCOUNT}
      export TF_VAR_region=${_TF_VAR_REGION}
      export TF_VAR_aws_access_key_id=${_TF_VAR_AWS_ACCESS_KEY_ID}
      export TF_VAR_aws_secret_access_key=${_TF_VAR_AWS_SECRET_ACCESS_KEY}
      export TF_VAR_aws_region=${_TF_VAR_AWS_REGION}
      terraform apply -auto-approve

substitutions:

  _TF_VAR_PROJECT_ID: "REPLACE_ME"
  _TF_VAR_COMPUTE_SERVICE_ACCOUNT: "REPLACE_ME"
  _TF_VAR_REGION: "us-central1"
  _TF_VAR_AWS_ACCESS_KEY_ID: "REPLACE_ME"
  _TF_VAR_AWS_SECRET_ACCESS_KEY: "REPLACE_ME"
  _TF_VAR_AWS_REGION: "eu-west-1"
